# Src Utils

[_Documentation generated by Documatic_](https://www.documatic.com)

<!---Documatic-section-Codebase Structure-start--->
## Codebase Structure

<!---Documatic-block-system_architecture-start--->
```mermaid
None
```
<!---Documatic-block-system_architecture-end--->

# #
<!---Documatic-section-Codebase Structure-end--->

<!---Documatic-section-src.utils.compute_conv_output_size-start--->
## [src.utils.compute_conv_output_size](3-src_utils.md#src.utils.compute_conv_output_size)

<!---Documatic-section-compute_conv_output_size-start--->
<!---Documatic-block-src.utils.compute_conv_output_size-start--->
<details>
	<summary><code>src.utils.compute_conv_output_size</code> code snippet</summary>

```python
def compute_conv_output_size(Lin, kernel_size, stride=1, padding=0, dilation=1):
    return int(np.floor((Lin + 2 * padding - dilation * (kernel_size - 1) - 1) / float(stride) + 1))
```
</details>
<!---Documatic-block-src.utils.compute_conv_output_size-end--->
<!---Documatic-section-compute_conv_output_size-end--->

# #
<!---Documatic-section-src.utils.compute_conv_output_size-end--->

<!---Documatic-section-src.utils.get_model-start--->
## [src.utils.get_model](3-src_utils.md#src.utils.get_model)

<!---Documatic-section-get_model-start--->
<!---Documatic-block-src.utils.get_model-start--->
<details>
	<summary><code>src.utils.get_model</code> code snippet</summary>

```python
def get_model(model):
    return deepcopy(model.state_dict())
```
</details>
<!---Documatic-block-src.utils.get_model-end--->
<!---Documatic-section-get_model-end--->

# #
<!---Documatic-section-src.utils.get_model-end--->

<!---Documatic-section-src.utils.human_format-start--->
## [src.utils.human_format](3-src_utils.md#src.utils.human_format)

<!---Documatic-section-human_format-start--->
<!---Documatic-block-src.utils.human_format-start--->
<details>
	<summary><code>src.utils.human_format</code> code snippet</summary>

```python
def human_format(num):
    magnitude = 0
    while abs(num) >= 1000:
        magnitude += 1
        num /= 1000.0
    return '%.1f%s' % (num, ['', 'K', 'M', 'G', 'T', 'P'][magnitude])
```
</details>
<!---Documatic-block-src.utils.human_format-end--->
<!---Documatic-section-human_format-end--->

# #
<!---Documatic-section-src.utils.human_format-end--->

<!---Documatic-section-src.utils.make_directories-start--->
## [src.utils.make_directories](3-src_utils.md#src.utils.make_directories)

<!---Documatic-section-make_directories-start--->
<!---Documatic-block-src.utils.make_directories-start--->
<details>
	<summary><code>src.utils.make_directories</code> code snippet</summary>

```python
def make_directories(args):
    uid = uuid.uuid4().hex
    if args.checkpoint is None:
        os.mkdir('checkpoints')
        args.checkpoint = os.path.join('./checkpoints/', uid)
        os.mkdir(args.checkpoint)
    else:
        if not os.path.exists(args.checkpoint):
            os.mkdir(args.checkpoint)
        args.checkpoint = os.path.join(args.checkpoint, uid)
        os.mkdir(args.checkpoint)
```
</details>
<!---Documatic-block-src.utils.make_directories-end--->
<!---Documatic-section-make_directories-end--->

# #
<!---Documatic-section-src.utils.make_directories-end--->

<!---Documatic-section-src.utils.print_log_acc_bwt-start--->
## [src.utils.print_log_acc_bwt](3-src_utils.md#src.utils.print_log_acc_bwt)

<!---Documatic-section-print_log_acc_bwt-start--->
<!---Documatic-block-src.utils.print_log_acc_bwt-start--->
<details>
	<summary><code>src.utils.print_log_acc_bwt</code> code snippet</summary>

```python
def print_log_acc_bwt(taskcla, acc, lss, output_path, run_id):
    print('*' * 100)
    print('Accuracies =')
    for i in range(acc.shape[0]):
        print('\t', end=',')
        for j in range(acc.shape[1]):
            print('{:5.4f}% '.format(acc[i, j]), end=',')
        print()
    avg_acc = np.mean(acc[acc.shape[0] - 1, :])
    print('ACC: {:5.4f}%'.format(avg_acc))
    print()
    print()
    gem_bwt = sum(acc[-1] - np.diag(acc)) / (len(acc[-1]) - 1)
    ucb_bwt = (acc[-1] - np.diag(acc)).mean()
    print('BWT: {:5.2f}%'.format(gem_bwt))
    print('*' * 100)
    print('Done!')
    logs = {}
    logs['name'] = output_path
    logs['taskcla'] = taskcla
    logs['acc'] = acc
    logs['loss'] = lss
    logs['gem_bwt'] = gem_bwt
    logs['ucb_bwt'] = ucb_bwt
    logs['rii'] = np.diag(acc)
    logs['rij'] = acc[-1]
    path = os.path.join(output_path, 'logs_run_id_{}.p'.format(run_id))
    with open(path, 'wb') as output:
        pickle.dump(logs, output)
    print('Log file saved in ', path)
    return (avg_acc, gem_bwt)
```
</details>
<!---Documatic-block-src.utils.print_log_acc_bwt-end--->
<!---Documatic-section-print_log_acc_bwt-end--->

# #
<!---Documatic-section-src.utils.print_log_acc_bwt-end--->

<!---Documatic-section-src.utils.print_running_acc_bwt-start--->
## [src.utils.print_running_acc_bwt](3-src_utils.md#src.utils.print_running_acc_bwt)

<!---Documatic-section-print_running_acc_bwt-start--->
<!---Documatic-block-src.utils.print_running_acc_bwt-start--->
<details>
	<summary><code>src.utils.print_running_acc_bwt</code> code snippet</summary>

```python
def print_running_acc_bwt(acc, task_num):
    print()
    acc = acc[:task_num + 1, :task_num + 1]
    avg_acc = np.mean(acc[acc.shape[0] - 1, :])
    gem_bwt = sum(acc[-1] - np.diag(acc)) / (len(acc[-1]) - 1)
    print('ACC: {:5.4f}%  || BWT: {:5.2f}% '.format(avg_acc, gem_bwt))
    print()
```
</details>
<!---Documatic-block-src.utils.print_running_acc_bwt-end--->
<!---Documatic-section-print_running_acc_bwt-end--->

# #
<!---Documatic-section-src.utils.print_running_acc_bwt-end--->

<!---Documatic-section-src.utils.print_time-start--->
## [src.utils.print_time](3-src_utils.md#src.utils.print_time)

<!---Documatic-section-print_time-start--->
<!---Documatic-block-src.utils.print_time-start--->
<details>
	<summary><code>src.utils.print_time</code> code snippet</summary>

```python
def print_time():
    from datetime import datetime
    now = datetime.now()
    dt_string = now.strftime('%d/%m/%Y %H:%M:%S')
    print('Job finished at =', dt_string)
```
</details>
<!---Documatic-block-src.utils.print_time-end--->
<!---Documatic-section-print_time-end--->

# #
<!---Documatic-section-src.utils.print_time-end--->

<!---Documatic-section-src.utils.report_tr-start--->
## [src.utils.report_tr](3-src_utils.md#src.utils.report_tr)

<!---Documatic-section-report_tr-start--->
<!---Documatic-block-src.utils.report_tr-start--->
<details>
	<summary><code>src.utils.report_tr</code> code snippet</summary>

```python
def report_tr(res, e, sbatch, clock0, clock1):
    print('| Epoch {:3d}, time={:5.1f}ms/{:5.1f}ms | Train losses={:.3f} | T: loss={:.3f}, acc={:5.2f}% | D: loss={:.3f}, acc={:5.1f}%, Diff loss:{:.3f} |'.format(e + 1, 1000 * sbatch * (clock1 - clock0) / res['size'], 1000 * sbatch * (time.time() - clock1) / res['size'], res['loss_tot'], res['loss_t'], res['acc_t'], res['loss_a'], res['acc_d'], res['loss_d']), end='')
```
</details>
<!---Documatic-block-src.utils.report_tr-end--->
<!---Documatic-section-report_tr-end--->

# #
<!---Documatic-section-src.utils.report_tr-end--->

<!---Documatic-section-src.utils.report_val-start--->
## [src.utils.report_val](3-src_utils.md#src.utils.report_val)

<!---Documatic-section-report_val-start--->
<!---Documatic-block-src.utils.report_val-start--->
<details>
	<summary><code>src.utils.report_val</code> code snippet</summary>

```python
def report_val(res):
    print(' Valid losses={:.3f} | T: loss={:.6f}, acc={:5.2f}%, | D: loss={:.3f}, acc={:5.2f}%, Diff loss={:.3f} |'.format(res['loss_tot'], res['loss_t'], res['acc_t'], res['loss_a'], res['acc_d'], res['loss_d']), end='')
```
</details>
<!---Documatic-block-src.utils.report_val-end--->
<!---Documatic-section-report_val-end--->

# #
<!---Documatic-section-src.utils.report_val-end--->

<!---Documatic-section-src.utils.save_code-start--->
## [src.utils.save_code](3-src_utils.md#src.utils.save_code)

<!---Documatic-section-save_code-start--->
<!---Documatic-block-src.utils.save_code-start--->
<details>
	<summary><code>src.utils.save_code</code> code snippet</summary>

```python
def save_code(args):
    cwd = os.getcwd()
    des = os.path.join(args.checkpoint, 'code') + '/'
    if not os.path.exists(des):
        os.mkdir(des)

    def get_folder(folder):
        return os.path.join(cwd, folder)
    folders = [get_folder(item) for item in ['dataloaders', 'networks', 'configs', 'main.py', 'acl.py', 'utils.py']]
    for folder in folders:
        call('cp -rf {} {}'.format(folder, des), shell=True)
```
</details>
<!---Documatic-block-src.utils.save_code-end--->
<!---Documatic-section-save_code-end--->

# #
<!---Documatic-section-src.utils.save_code-end--->

<!---Documatic-section-src.utils.save_print_log-start--->
## [src.utils.save_print_log](3-src_utils.md#src.utils.save_print_log)

<!---Documatic-section-save_print_log-start--->
<!---Documatic-block-src.utils.save_print_log-start--->
<details>
	<summary><code>src.utils.save_print_log</code> code snippet</summary>

```python
def save_print_log(taskcla, acc, lss, output_path):
    print('*' * 100)
    print('Accuracies =')
    for i in range(acc.shape[0]):
        print('\t', end=',')
        for j in range(acc.shape[1]):
            print('{:5.4f}% '.format(acc[i, j]), end=',')
        print()
    print('ACC: {:5.4f}%'.format(np.mean(acc[acc.shape[0] - 1, :])))
    print()
    print('BWD Transfer = ')
    print()
    print('Diagonal R_ii')
    for i in range(acc.shape[0]):
        print('\t', end='')
        print('{:5.2f}% '.format(np.diag(acc)[i]), end=',')
    print()
    print('Last row')
    for i in range(acc.shape[0]):
        print('\t', end=',')
        print('{:5.2f}% '.format(acc[-1][i]), end=',')
    print()
    gem_bwt = sum(acc[-1] - np.diag(acc)) / (len(acc[-1]) - 1)
    ucb_bwt = (acc[-1] - np.diag(acc)).mean()
    print('BWT: {:5.2f}%'.format(gem_bwt))
    print('*' * 100)
    print('Done!')
    logs = {}
    logs['name'] = output_path
    logs['taskcla'] = taskcla
    logs['acc'] = acc
    logs['loss'] = lss
    logs['gem_bwt'] = gem_bwt
    logs['ucb_bwt'] = ucb_bwt
    logs['rii'] = np.diag(acc)
    logs['rij'] = acc[-1]
    with open(os.path.join(output_path, 'logs.p'), 'wb') as output:
        pickle.dump(logs, output)
    print('Log file saved in ', os.path.join(output_path, 'logs.p'))
```
</details>
<!---Documatic-block-src.utils.save_print_log-end--->
<!---Documatic-section-save_print_log-end--->

# #
<!---Documatic-section-src.utils.save_print_log-end--->

<!---Documatic-section-src.utils.some_sanity_checks-start--->
## [src.utils.some_sanity_checks](3-src_utils.md#src.utils.some_sanity_checks)

<!---Documatic-section-some_sanity_checks-start--->
<!---Documatic-block-src.utils.some_sanity_checks-start--->
<details>
	<summary><code>src.utils.some_sanity_checks</code> code snippet</summary>

```python
def some_sanity_checks(args):
    datasets_tasks = {}
    datasets_tasks['mnist5'] = [5]
    datasets_tasks['pmnist'] = [10, 20, 30, 40]
    datasets_tasks['cifar100'] = [20]
    datasets_tasks['miniimagenet'] = [20]
    datasets_tasks['multidatasets'] = [5]
    if not args.ntasks in datasets_tasks[args.experiment]:
        raise Exception('Chosen number of tasks ({}) does not match with {} experiment'.format(args.ntasks, args.experiment))
    if args.use_memory == 'yes' and (not args.samples > 0):
        raise Exception('Flags required to use memory: --use_memory yes --samples n where n>0')
    if args.use_memory == 'no' and args.samples > 0:
        raise Exception('Flags required to use memory: --use_memory yes --samples n where n>0')
```
</details>
<!---Documatic-block-src.utils.some_sanity_checks-end--->
<!---Documatic-section-some_sanity_checks-end--->

# #
<!---Documatic-section-src.utils.some_sanity_checks-end--->

[_Documentation generated by Documatic_](https://www.documatic.com)